<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>旅遊照片上傳</title>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div class="bg-white shadow-xl rounded-2xl p-8 w-full max-w-lg">
    <h2 class="text-2xl font-bold text-center text-indigo-600 mb-6">📷 旅遊照片上傳</h2>

    <!-- 登入按鈕 -->
    <div class="flex justify-center mb-6">
      <button id="login" 
        class="px-6 py-2 bg-indigo-500 text-white rounded-lg shadow hover:bg-indigo-600 transition">
        登入 Google
      </button>
    </div>

    <!-- 子資料夾選擇 -->
    <label class="block mb-2 text-gray-700">選擇子資料夾：</label>
    <select id="subfolder" 
      class="w-full p-2 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-indigo-400">
    </select>

    <!-- 建立新資料夾 -->
    <label class="block mb-2 text-gray-700">或建立新資料夾：</label>
    <div class="flex mb-6">
      <input type="text" id="newFolderName" placeholder="輸入新資料夾名稱"
        class="flex-grow p-2 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-indigo-400">
      <button id="createFolder" 
        class="px-4 bg-green-500 text-white rounded-r-lg hover:bg-green-600 transition">
        建立
      </button>
    </div>

    <!-- 檔案選擇與上傳 -->
    <input type="file" id="file" multiple 
      class="block w-full mb-4 text-gray-700 file:mr-4 file:py-2 file:px-4
             file:rounded-lg file:border-0 file:text-sm file:font-semibold
             file:bg-indigo-50 file:text-indigo-600
             hover:file:bg-indigo-100">
    <button id="upload" 
      class="w-full py-2 bg-indigo-500 text-white rounded-lg shadow hover:bg-indigo-600 transition">
      ⬆️ 上傳檔案
    </button>

    <!-- 狀態顯示 -->
    <div id="status" class="mt-6 text-gray-700 text-sm leading-relaxed"></div>
  </div>

  <script>
    const CLIENT_ID = "279897575373-3gtk5s6df3uf8oj3h44nccsca0aigmu0.apps.googleusercontent.com";
    const API_KEY = "你的 API Key";
    const SCOPES = "https://www.googleapis.com/auth/drive.file";
    const PARENT_FOLDER_ID = "1yR8pE1Pz7hNwJ9d-srxwrE6zsjh_GsHY"; 
    const APPS_SCRIPT_URL = "https://sepal1111.github.io/Photo_Upload/";

    let tokenClient;

    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
      await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
      });
      document.getElementById("login").onclick = handleAuthClick;
      document.getElementById("upload").onclick = uploadFiles;
      document.getElementById("createFolder").onclick = createNewFolder;
    }

    function handleAuthClick() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: () => {
          listSubfolders();
        },
      });
      tokenClient.requestAccessToken();
    }

    async function listSubfolders() {
      const res = await gapi.client.drive.files.list({
        q: `'${PARENT_FOLDER_ID}' in parents and mimeType = 'application/vnd.google-apps.folder' and trashed = false`,
        fields: "files(id, name)",
      });

      const folderSelect = document.getElementById("subfolder");
      folderSelect.innerHTML = "";
      res.result.files.forEach(f => {
        const opt = document.createElement("option");
        opt.value = f.id;
        opt.textContent = f.name;
        folderSelect.appendChild(opt);
      });
    }

    async function createNewFolder() {
      const name = document.getElementById("newFolderName").value.trim();
      if (!name) return alert("請輸入資料夾名稱");

      const res = await gapi.client.drive.files.create({
        resource: {
          name: name,
          mimeType: "application/vnd.google-apps.folder",
          parents: [PARENT_FOLDER_ID],
        },
        fields: "id, name",
      });

      const folderSelect = document.getElementById("subfolder");
      const opt = document.createElement("option");
      opt.value = res.result.id;
      opt.textContent = res.result.name;
      folderSelect.appendChild(opt);
      folderSelect.value = res.result.id;

      document.getElementById("newFolderName").value = "";
      alert("新資料夾已建立：" + res.result.name);
    }

    async function uploadFiles() {
      const files = document.getElementById("file").files;
      if (files.length === 0) return alert("請先選擇檔案");

      const folderId = document.getElementById("subfolder").value || PARENT_FOLDER_ID;
      const status = document.getElementById("status");
      status.innerHTML = "開始上傳...<br>";

      for (const file of files) {
        const metadata = {
          name: file.name,
          parents: [folderId],
        };

        const form = new FormData();
        form.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
        form.append("file", file);

        const res = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id", {
          method: "POST",
          headers: new Headers({ "Authorization": "Bearer " + gapi.client.getToken().access_token }),
          body: form,
        });
        const data = await res.json();

        status.innerHTML += `✅ 已上傳：${file.name}<br>`;

        // 呼叫 Apps Script 改擁有者
        fetch(APPS_SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify({ fileId: data.id }),
        });
      }
      status.innerHTML += "<br>🎉 全部檔案已上傳完成！";
    }

    window.onload = gapiLoaded;
  </script>
</body>
</html>
