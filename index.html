<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>æ—…éŠç…§ç‰‡ä¸Šå‚³</title>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div class="bg-white shadow-xl rounded-2xl p-8 w-full max-w-lg">
    <h2 class="text-2xl font-bold text-center text-indigo-600 mb-6">ğŸ“· æ—…éŠç…§ç‰‡ä¸Šå‚³</h2>

    <!-- ç™»å…¥æŒ‰éˆ• -->
    <div class="flex justify-center mb-6">
      <button id="login" 
        class="px-6 py-2 bg-indigo-500 text-white rounded-lg shadow hover:bg-indigo-600 transition">
        ç™»å…¥ Google
      </button>
    </div>

    <!-- å­è³‡æ–™å¤¾é¸æ“‡ -->
    <label class="block mb-2 text-gray-700">é¸æ“‡å­è³‡æ–™å¤¾ï¼š</label>
    <select id="subfolder" 
      class="w-full p-2 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-indigo-400">
    </select>

    <!-- å»ºç«‹æ–°è³‡æ–™å¤¾ -->
    <label class="block mb-2 text-gray-700">æˆ–å»ºç«‹æ–°è³‡æ–™å¤¾ï¼š</label>
    <div class="flex mb-6">
      <input type="text" id="newFolderName" placeholder="è¼¸å…¥æ–°è³‡æ–™å¤¾åç¨±"
        class="flex-grow p-2 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-indigo-400">
      <button id="createFolder" 
        class="px-4 bg-green-500 text-white rounded-r-lg hover:bg-green-600 transition">
        å»ºç«‹
      </button>
    </div>

    <!-- æª”æ¡ˆé¸æ“‡èˆ‡ä¸Šå‚³ -->
    <input type="file" id="file" multiple 
      class="block w-full mb-4 text-gray-700 file:mr-4 file:py-2 file:px-4
             file:rounded-lg file:border-0 file:text-sm file:font-semibold
             file:bg-indigo-50 file:text-indigo-600
             hover:file:bg-indigo-100">
    <button id="upload" 
      class="w-full py-2 bg-indigo-500 text-white rounded-lg shadow hover:bg-indigo-600 transition">
      â¬†ï¸ ä¸Šå‚³æª”æ¡ˆ
    </button>

    <!-- ç‹€æ…‹é¡¯ç¤º -->
    <div id="status" class="mt-6 text-gray-700 text-sm leading-relaxed"></div>
  </div>

  <script>
    const CLIENT_ID = "279897575373-3gtk5s6df3uf8oj3h44nccsca0aigmu0.apps.googleusercontent.com";
    const API_KEY = "ä½ çš„ API Key";
    const SCOPES = "https://www.googleapis.com/auth/drive.file";
    const PARENT_FOLDER_ID = "1yR8pE1Pz7hNwJ9d-srxwrE6zsjh_GsHY"; 
    const APPS_SCRIPT_URL = "https://sepal1111.github.io/Photo_Upload/";

    let tokenClient;

    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
      await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
      });
      document.getElementById("login").onclick = handleAuthClick;
      document.getElementById("upload").onclick = uploadFiles;
      document.getElementById("createFolder").onclick = createNewFolder;
    }

    function handleAuthClick() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: () => {
          listSubfolders();
        },
      });
      tokenClient.requestAccessToken();
    }

    async function listSubfolders() {
      const res = await gapi.client.drive.files.list({
        q: `'${PARENT_FOLDER_ID}' in parents and mimeType = 'application/vnd.google-apps.folder' and trashed = false`,
        fields: "files(id, name)",
      });

      const folderSelect = document.getElementById("subfolder");
      folderSelect.innerHTML = "";
      res.result.files.forEach(f => {
        const opt = document.createElement("option");
        opt.value = f.id;
        opt.textContent = f.name;
        folderSelect.appendChild(opt);
      });
    }

    async function createNewFolder() {
      const name = document.getElementById("newFolderName").value.trim();
      if (!name) return alert("è«‹è¼¸å…¥è³‡æ–™å¤¾åç¨±");

      const res = await gapi.client.drive.files.create({
        resource: {
          name: name,
          mimeType: "application/vnd.google-apps.folder",
          parents: [PARENT_FOLDER_ID],
        },
        fields: "id, name",
      });

      const folderSelect = document.getElementById("subfolder");
      const opt = document.createElement("option");
      opt.value = res.result.id;
      opt.textContent = res.result.name;
      folderSelect.appendChild(opt);
      folderSelect.value = res.result.id;

      document.getElementById("newFolderName").value = "";
      alert("æ–°è³‡æ–™å¤¾å·²å»ºç«‹ï¼š" + res.result.name);
    }

    async function uploadFiles() {
      const files = document.getElementById("file").files;
      if (files.length === 0) return alert("è«‹å…ˆé¸æ“‡æª”æ¡ˆ");

      const folderId = document.getElementById("subfolder").value || PARENT_FOLDER_ID;
      const status = document.getElementById("status");
      status.innerHTML = "é–‹å§‹ä¸Šå‚³...<br>";

      for (const file of files) {
        const metadata = {
          name: file.name,
          parents: [folderId],
        };

        const form = new FormData();
        form.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
        form.append("file", file);

        const res = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id", {
          method: "POST",
          headers: new Headers({ "Authorization": "Bearer " + gapi.client.getToken().access_token }),
          body: form,
        });
        const data = await res.json();

        status.innerHTML += `âœ… å·²ä¸Šå‚³ï¼š${file.name}<br>`;

        // å‘¼å« Apps Script æ”¹æ“æœ‰è€…
        fetch(APPS_SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify({ fileId: data.id }),
        });
      }
      status.innerHTML += "<br>ğŸ‰ å…¨éƒ¨æª”æ¡ˆå·²ä¸Šå‚³å®Œæˆï¼";
    }

    window.onload = gapiLoaded;
  </script>
</body>
</html>
